\chapter{From signals to images}
\label{chapter:two}
%Contiene el m√©todo y el enfoque.

%Mental Chrometry and averaging 
%https://www.ncbi.nlm.nih.gov/pmc/articles/PMC548951/

This chapter describes the procedure to plot an image from the digital EEG signal.  This image is used to extract a feature which represents the waveform, the structure of the signal on a plot.  By analyzing this feature, we hypothesize that the underlying cognitive process can be detected and it can be used to implement a brain-computer communication device.

\section{Electroencephalographic Plotting}

The plotting of the EEG is intrinsically mixed with the nuisances of the electroencephalography itself.  Plotting proceed by using a chart recorded with a single pen~\cite{Jestico1977}.   Voltages are represented on a vertical axis while time is represented on the horizontal axis, in a Cartesian arrangement. 

\begin{enumerate}
\item Sensitivity: also termed gain due the amplification procedure.  Its units are $ \frac{mV}{mm}$.  In the digital form, it is $\frac{\mu V}{pixel}$.
\item Epoch/Paper speed: the time span that is represented in a single screen.  For paper strips it is usually $10s$.  In its digital counterpart is $ \frac{w}{pixel}$ with $w$ being the length in milliseconds of the signal segment.
\end{enumerate}

On analog plotting, montage is essential, but digital plotting allows to implement flexible configuration.  Montage can be monopolar or bipolar.  On monopolar montages each electrode obtains the potential difference against a common reference, and with bipolar montages, electrodes are paired, even in chained configurations. The potential difference is obtained between each pair of electrodes~\cite{EEGIntro}.

%Logarithmic plotting, montage, calibration (cite Electroencphalograpy for empilepsy society)

\begin{story}[Neuroimaging]
With the advent of digital computers and the digital revolution, Plotting has become imaging.  Neuroimaging~\cite{Freeman2013} means mapping activity or structure to neuroanatomical regions.

There are currently three categories of neuroimaging: \textit{structural} includes CT (Computed Tomography), MRI (Magnetic Resonance Imaging) and DTI (Diffusion Tensor Imaging), \textit{functional}, which encompass EEG, MEG (Magnetoencephalography), fMRI (functional MRI) PET (Positron Emission Tomography), SPECT (Single Positron Emission Computed Tomography), NIRS (Near-Infrared Spectroscopy) and \textit{chemical} which involves dyes which are sensible to neuron firing.
\end{story}

\section{Signal to Image transformation}

The EEG signal may be represented by

\begin{equation}
\mathbf{x}(n) = x(n,c)
\label{eq:zerolevel}
\end{equation}

\noindent where $n$ are sample points digitalized at sampling frequency $F_s$.  This is a multichannel signal, for $c$ varying between  $1 \leq c \leq C$.  Each one of this channels is assigned a name according to the 10-20 international system, and there are $C$ available channels. The sample index $n$ varies between $1$ and $N$.  The span of the signal $\lambda$ is the length in milliseconds of the waveform under study. When the segment encompass the entire waveform and as the segment is in general 1s length, this is the inverse of the sampling frequency.

\begin{equation}
N = \left\lfloor F_s \; w \right\rfloor
\label{eq:segmentlength}
\end{equation}

\vspace{3pt}

To extract features from an image, we first construct an image which represents the underlying signal.  The straightforward way to do it, reproducing the traditional analog or digital EEG, is to draw a line on a contrast background.  This line represents the voltage amplitude of the corresponding channel in relation to a zero-level $z(c)$, with a positive deflection going upwards (towards the zero value in the image coordinate system) and downwards for negative deflection.  Figure \ref{fig:plottingsample} shows an EEG signal segment sample plot.  If only two colors are used, this image is a black-and-white binary image.  The color selection is arbitrary (white for the line, black for the background), but it has some implications in terms of the feature extraction procedure that we will describe later.

\begin{figure}[]
\centering
\includegraphics[scale=1.5]{images/plottingsample.png}
\caption[EEG Signal Mapping to Images]{Sample EEG signal plotting.  For this sample image, the span of the signal is 1s, which is 250 sample points.  The height of the image is 73 pixels, which is the peak-to-peak amplitude of the signal segment.  Channel Oz of baseline EEG activity is being shown.}
\label{fig:plottingsample}
\end{figure}

This chapter mostly deal with the coordinates transformation that need to be enforced while converting the signal into a plot.  Figure \ref{fig:imagecoordinatesystem} shows the image coordinate system where the $(z_1,z_2)$ represents the horizontal and vertical location, and the $(0,0)$ value is the upper-left position of the image.

\begin{figure}[]
\centering
\includegraphics[scale=1]{images/imagecoordinatesystem.pdf}
\caption[Image Coordinate System]{The image coordinate system and the mapping from the signal segment.  The origin is the $(0,0)$ position at the upper-left corner of the image.  Time is represented as sample points on the horizontal axis and the amplitude in $\mu V$ is shown on the vertical axis. Image height $H_y$ and width $W_x$ are obtained based on signal parameters.  The signal's zero-level $z(c)$ is the vertical location where the signal zero value is located. The plot of the signal is obtained by first setting the sample points on the predetermined image locations according to equation \ref{eq:images} and then applying a discrete interpolation algorithm to connect them with straight lines. }
\label{fig:imagecoordinatesystem}
\end{figure}

%\begin{figure}[]
%\centering
%\includegraphics[scale=0.2]{images/SignalTransformation.jpg}
%\caption[EEG Signal Mapping to Images]{Six ways of mapping an EEG signal segment into a binary or greyscale image.}
%\label{fig:mappingimages}
%\end{figure}


In order to convert the EEG original signal into an image, the following six alternatives can be used, where the $I(z_1,z_2)$ is the generated image.

\begin{itemize}
\item Channel by Channel binary image

The standard plotting, on a black-and-white image with lines representing voltage amplitude.

\begin{equation}
I(z_1,z_2) = \left\{ \begin{array}{rl}
255 & \text{if} \,  z_1 =  n; \; z_2 = x(n,c) + z(c) \\
0   & \mbox{otherwise}
\end{array}\right.
\label{eq:images}
\end{equation}

\item Channel by channel grey color image

The voltage amplitudes are represented by grey scale colors, that could range between 0 and 255.  The function $\phi( \cdot )$ is a bounded linear mapping.

\begin{equation}
I(z_1,z_2) = \left\{ \begin{array}{rl}
\phi(x(n,c)) & \text{if} \,  z_1 = n; \; z_2 = z(c) \\
0   & \mbox{otherwise}
\end{array}\right.
\label{eq:images}
\end{equation}

\item Multichannel Full grey color image

The image is grey-scale. Voltage amplitudes are represented by the pixel content and each channel is represented on the vertical axis.  The height of the signal is equal to the number of channels.   This is used in Neuroimaging plots of ERP events.

\begin{equation}
I(z_1,z_2) = \left\{ \begin{array}{rl} \phi(x(n,c))  & \text{if} \,  z_1 = n; \; z_2 = c \end{array}\right.
\label{eq:images}
\end{equation}


\item Multichannel Stationary Binary image

The horizontal axis of the image is not time, but it is channels instead.   In this representation different contributions from different channels can be explored at the same time, but time dynamics is lost.  

\begin{equation}
I(z_1,z_2) = \left\{ \begin{array}{rl}
255 & \text{if} \,  z_1 = c; \; z_2 =  x(n,c) + z(n) \\
0   & \mbox{otherwise}
\end{array}\right.
\label{eq:images}
\end{equation}

\item Multichannel Stationary Grey-scale image

This is a variant of the previous one, where the horizontal axis represent the channel.   In this form, the intensity of the contribution of each channel is represented by the grey-scale pixel value.  Combined with head models and forward projection solutions this is the approach used to represent scalp heatmaps~\cite{Gramfort2013}.

\begin{equation}
I(z_1,z_2) = \left\{ \begin{array}{rl}
\phi(x(n,c)) & \text{if} \,  z_1 = c; \; z_2 =  z(n) \\
0   & \mbox{otherwise}
\end{array}\right.
\label{eq:images}
\end{equation}


\item Channel by channel full grey color image

This is similar to a raster plot but the greyscale image representing voltages in pixel intensities is repeated $H$ times, which is the height of the image.  The selection of this value is arbitrary.

\begin{equation}
I(z_1,z_2) = \left\{ \begin{array}{rl} \phi(x(n,c_i))  & \text{if} \,  z_1 = n; \; z_2 = H \end{array}\right.
\label{eq:images}
\end{equation}

%This last representation has the important property that $ LoG(I(x,0)) = LoG(x(n,c)) $.

\end{itemize}

\section{EEG Signal Plot}

A binary image plot $I^{(c)}$ can be constructed according to

\begin{equation}
I^{(c)}(z_1,z_2) = \left\{ \begin{array}{rl}
255 & \text{if} \,  z_1 = \gamma_{t} \  n; \! z_2 = \left\lfloor \gamma \; \tilde{x}(n,c) \right\rceil + z(c) \\
0   & \mbox{otherwise}
\end{array}\right.
\label{eq:images}
\end{equation}

\noindent with $255$ being white and representing the signal's voltage and $0$ for black which is the background contrast, conforming a black-and-white plot of the signal.  Pixel arguments $ (z_1,z_2) \in \mathbb{N} \times \mathbb{N}$ iterate over the width and height of the image plot with $1 \leq n \leq N$ and $1 \leq c \leq C$.  There is one image per channel.  The parameters $\gamma$ and $\gamma_t$ are the scaling factors in sample points and in amplitude.  They are used to determine the image size and at the same time the image resolution.

To analyze effectively an EEG signal, many signal segments are produced.  Hence, the transformation from signal to image is continuously repeated, and many images need to be produced for each segment of the EEG signal under analysis.  How to determine the size of all the images so that they can be effectively compared automatically ?  The first way is to regularize the signal and fit in an equal size for all of them.  An alternative choice is to autoscale every image according to the zero-level position.  Figure \ref{fig:plottingscheme} shows two sample impulse signals and their two alternative representations into images.

\subsection{Standardized plotting}

There are many ways to regularize the signal, but the \textit{z-score} is widely used to perform this operation~\cite{Zhang2013}.

The standardization is defined for  $1 \leq n \leq N$ and $1 \leq c \leq C$ by doing

\begin{equation}
\tilde{x}(n,c) =  \frac{( x(n,c) - \bar{x}(c)  )}{ \hat{\sigma}(c) } 
\label{eq:standarizedaverages}
\end{equation}

\noindent  where $ x(n,c) $ is the multichannel EEG signal segment for the sample point $n$ and for channel $c$. The values $$\bar{x}(c) =\frac{1}{N}\sum_{n=1}^{N}x(n,c)$$ and $$ \hat{\sigma}(c) = (\frac{1}{N-1}\sum_{n=1}^{N}(x(n,c)-\bar{x}(c))^2 )^{\frac{1}{2}}$$ are the mean and estimated standard deviation of $x(n,c), 1 \leq n \leq N$, for each channel $c$.

The zero-level $z(c)$ is the image vertical position where the signal's zero value has to be situated in order to fit the entire signal within the image for each channel c:

\begin{equation}
z(c) = \left \lfloor{ \frac{\max_{n} \tilde{x}(n,c)  - \min_{n} \tilde{x}(n,c) }{2} }\right \rfloor -   \left \lfloor{ \frac{\max_{n} \tilde{x}(n,c)  + \min_{n} \tilde{x}(n,c)}{ 2} }\right \rfloor
\label{eq:zerolevel}
\end{equation}

\noindent where the minimization and maximization are carried out for $n$ varying between ${1 \leq n\leq N}$, and $ \lfloor \cdot  \rfloor $ denote the rounding to the smaller nearest integer of the number.  This value represents the vertical location on the image where the signal goes to zero.  Figure \ref{fig:plottingscheme}(a) shows an impulse signal and their standardized representation.


\subsection{Autoscaled plotting}

This plotting scheme allows each image to adapt to the underlying signal.  The height is set at twice the value of the zero-level, and the signal mean is subtracted from the signal, which is a vertical displacement.

\begin{equation}
\tilde{x}(n,c) =  x(n,c) - \bar{x}(c) 
\label{eq:autoscaled}
\end{equation}

Figure \ref{fig:plottingscheme}(b) shows the results of the plotting for an impulse signal.

\begin{figure}[htb]
\centering
\subfigure[A signal pulse determines the height of the plotted image. The signal is standardized and the height of the image is determined according to the peak-to-peak amplitude, which is in constant for every image and equal to $\gamma$. ]
{\includegraphics[height=5cm,width=15cm]{images/signalplot1.eps}}
\subfigure[The plotted image is twice the zero-level. In this case, the height is also determined according to the peak-to-peak amplitude of each segment, proportional to $\gamma$, and not constant. Transformed images do not have the same height, but the zero-level is always located at half the height of the image.]{\includegraphics[height=5cm,width=15cm]{images/signalplot2.eps}}
\caption[Signal plot of an impulse response]{Signal plotting schemes.}
\label{fig:plottingscheme}
\end{figure}

\subsection{Image Size}

\subsubsection{Height}

The height of the image is calculated according to the peak-to-peak amplitude of the signal,

\begin{equation}
H_y = \max \left\lfloor \gamma \; \tilde{x}(n,c) \right\rceil  - \min \left\lfloor \gamma \; \tilde{x}(n,c) \right\rceil 
\label{eq:height}
\end{equation}

\noindent while for the autoscalable version, it is just twice the value of the zero-level.

\begin{equation}
H_y = 2 \; z(c)
\label{eq:autoscaleheight}
\end{equation}


\subsubsection{Width}

The width on the other hand is obtained based on the span of the signal segment, scaled by the $\gamma_t$  time factor,

\begin{equation}
W_x = \gamma_t  N
\label{eq:width}
\end{equation}


\subsection{Pixelation}

EEG time-series are floating-point numbers and the image is constructed based on discrete and integer pixels.  

\begin{equation}
z_2 = \left \lfloor{ \gamma  \; \tilde{x}(n,c)  }\right \rceil
\label{eq:standarizedaverages}
\end{equation}

\noindent where $\gamma$ is the scale parameter, which also affects the height of the image in Equation \ref{eq:height}.

On the other hand, on the horizontal axis, $z_1$, no discretization is needed because time is already digitalized in sample units. 

\subsection{Interpolation}

Equation \ref{eq:images} produces a set of isolated pixels over the image.  To produce the plot $I^{(c)}$, the Bresenham \cite{Bresenham1965,Ramele2016} algorithm is used to interpolate straight lines between each pair of consecutive pixels.

\begin{figure}[htb]
\centering
\subfigure[A sampled EEG signal interpolated with the Bresenham algorithm. ]
{\includegraphics[height=5cm,width=15cm]{images/s_1_e_1_c_7_4.png}}
\subfigure[An interpolated upsampled EEG signal.  Once the new set of sample points are generated, the plot is also interpolated with the Bresenham algorithm.]
{\includegraphics[height=5cm,width=15cm]{images/s_1_e_1_c_7_4.png}}
\caption[Signal Plotting: Interpolation]{Generated images based on different interpolation schemes.}
\label{fig:interpolation}
\end{figure}

However, as seen in Figure, it can lead to very sharp edges around sample pixels.  This can lead to a quantization of histogram gradients. The alternative is to use a smoothing interpolated using splines.  Instead of just skipping time points values, these values are interpolated according to a linear quadratic or cubic interpolation, which smooths the curve around each point.  This procedure can be implemented by the Matlab function \textbf{resample} which applies an antialiasing FIR lowpass filter.

Special care must be taken to avoid artifacts around the edges of the signal, so a windowing procedure is also necessary to avoid this (e.g. Hamming).

\subsection{Resolution}

According to the plotting scheme, a resolution is established between pixel images and signal properties.

On the horizontal axis of the image, one pixel is equivalent to 

\begin{equation}
1 P_x \equiv \frac{1}{F_s \; w \; \gamma_t}  [\si{s}]
\label{eq:resolutionx}
\end{equation}

\noindent where $F_s$ is the sampling frequency in Hertz, $w$ is the length of the signal segment (in milliseconds), and $\gamma_t$ is the scale factor.  This gives a value in seconds.  For example, for Figure \ref{fig:imagecoordinatesystem}, the sampling frequency is $200 Hz$, the length is $0.65 s$ and $\gamma_t = 1$, which gives a resolution of $1 P_x \equiv 0.0077 s$. 

Consistently, on the vertical axis, one pixel is analogous to 

\begin{equation}
1 P_y \equiv \frac{1}{\gamma}  [\si\mu{V}]
\label{eq:resolutiony}
\end{equation}

\noindent where $\gamma$ is the signal scale.  As EEG time-series are digitalized in $\si\mu{V}$, this the unit of choice.  In Figure \ref{fig:imagecoordinatesystem}, $1$ vertical pixel represents exactly $1 \mu V$.

\section{Mapping}

The initial parameters are $N$,$F_s$ and $\lambda$.  The unit length of the patch is $\Delta_s = \sqrt{2} \; 15$.  The peak-to-peak amplitude of the waveform to study is $ \Delta \mu V $.

\paragraph{Resolution}

\begin{equation}
1 P_x \equiv \frac{1}{F_s \; w \; \gamma_t}  [\si{s}]
\label{eq:resolutionx}
\end{equation}

\begin{equation}
1 P_y \equiv \frac{1}{\gamma}  [\si\mu{V}]
\label{eq:resolutiony}
\end{equation}

\begin{equation}
\gamma \equiv \frac{H_y}{\Delta \mu V}  
\label{eq:gammadefinition}
\end{equation}

\begin{equation}
\gamma_t \equiv \frac{W_x}{F_s \; w}  
\label{eq:gammatdefinition}
\end{equation}

\begin{equation}
s_x = \frac{ \gamma \;  \lambda \  F_s}{12}
\label{eq:mapping2}
\end{equation}

\begin{equation}
s_y= \frac{\gamma \; \Delta \mu V}{12} 
\label{eq:mapping1}
\end{equation}


\begin{equation}
\frac{W_x-1}{\sqrt{2} \; 15}  \leq S_t 
\label{eq:restriction1}
\end{equation}

\begin{equation}
\frac{H_y-1}{\sqrt{2} \; 15}  \leq S_v 
\label{eq:restriction2}
\end{equation}

\begin{equation}
S_t = \frac{ \lambda \;  \  F_s \ \gamma_t }{\Delta_s}
\label{eq:mapping2}
\end{equation}

\begin{equation}
S_v= \frac{\Delta \mu V \ \gamma}{\Delta_s} 
\label{eq:mapping1}
\end{equation}



\begin{equation}
n = \left\lfloor F_s \ \Delta_t \right\rfloor \ \gamma_t
\label{eq:mapping1}
\end{equation}



\begin{equation}
\mathbf{S}_x = \Delta_s \; S_t + 1
\label{eq:mapping2}
\end{equation}

\begin{equation}
\mathbf{S}_y = \Delta_s \; S_v + 1
\label{eq:mapping1}
\end{equation}


Length of a Patch

\begin{equation}
\Delta_t = \frac{S_t \ \Delta_s}{F_s \ \gamma_t} 
\label{eq:mapping1}
\end{equation}

